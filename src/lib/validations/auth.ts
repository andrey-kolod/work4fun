// ============================================================================
// ФАЙЛ: /src/lib/validations/auth.ts
// НАЗНАЧЕНИЕ: Валидация (проверка) данных для аутентификации
// ----------------------------------------------------------------------------
// Этот файл содержит схемы проверки данных с помощью библиотеки Zod.
// Zod - это как "охранник" для данных: он проверяет, чтобы email был правильным,
// пароль - достаточно длинным, и т.д.
//
// Почему это нужно?
// 1. Защищает от ошибок пользователя (например, опечатки в email).
// 2. Защищает сервер от вредных данных (например, слишком длинный пароль).
// 3. Работает на фронтенде и бэкенде (один код для всего).
// 4. Автоматически генерирует типы TypeScript (чтобы код не ломался).
//
// Как работает Zod?
// - z.object({ ... }) - создает "шаблон" объекта.
// - .string() - проверяет, что поле - строка.
// - .min(1, 'Сообщение') - добавляет правило и сообщение об ошибке.
// - .refine() - для сложных проверок (например, пароли совпадают).
// - .transform() - изменяет данные (например, убрать пробелы).
// ============================================================================

import { z } from 'zod'; // Импортируем Zod - библиотеку для валидации.

// Схема для входа в систему (login)
// Это шаблон для данных формы входа: email + password.
export const loginSchema = z.object({
  // Поле email:
  // - Должно быть строкой (z.string()).
  // - Не пустым (min(1)).
  // - Валидным email (email()).
  // - Не длиннее 255 символов (max(255)).
  // - transform: приводим к нижнему регистру и убираем пробелы (trim()).
  email: z
    .string()
    .min(1, 'Email обязателен для заполнения') // Ошибка если пусто.
    .email('Введите корректный email адрес') // Проверяет формат email@domain.com.
    .max(255, 'Email не может быть длиннее 255 символов') // Ограничение по PRD.
    .transform((email) => email.toLowerCase().trim()), // Преобразование: нижний регистр + убрать пробелы.

  // Поле password:
  // - Строка.
  // - Не пустая (min(1)).
  // - Нет других проверок (для login - простая, детальные в register).
  password: z.string().min(1, 'Пароль обязателен для заполнения'),
});

// Тип для данных login (автоматически из схемы)
// TypeScript использует это, чтобы знать: LoginInput = { email: string, password: string }.
export type LoginInput = z.infer<typeof loginSchema>;

// Схема для регистрации (register)
// Более строгая, чем login: добавлены имя, фамилия, телефон, подтверждение пароля, согласия.
export const registerSchema = z
  .object({
    // Email: как в login.
    email: z
      .string()
      .min(1, 'Email обязателен для заполнения')
      .email('Введите корректный email адрес')
      .max(255, 'Email не может быть длиннее 255 символов')
      .transform((email) => email.toLowerCase().trim()),

    // firstName: имя по PRD (2-50 символов, только буквы/пробелы/дефисы/апострофы).
    // regex: регулярное выражение - проверяет символы.
    firstName: z
      .string()
      .min(2, 'Имя должно содержать от 2 до 50 символов')
      .max(50, 'Имя должно содержать от 2 до 50 символов')
      .regex(
        /^[a-zA-Zа-яА-ЯёЁ\s\-']+$/, // Разрешенные символы: буквы (рус/англ), пробелы, дефисы, апострофы.
        'Имя может содержать только буквы, пробелы, дефисы и апострофы'
      )
      .transform((name) => name.trim()), // Убрать пробелы по краям.

    // lastName: то же, что firstName.
    lastName: z
      .string()
      .min(2, 'Фамилия должна содержать от 2 до 50 символов')
      .max(50, 'Фамилия должна содержать от 2 до 50 символов')
      .regex(
        /^[a-zA-Zа-яА-ЯёЁ\s\-']+$/,
        'Фамилия может содержать только буквы, пробелы, дефисы и апострофы'
      )
      .transform((name) => name.trim()),

    // phone: опционально (optional()).
    // Если есть - только цифры/пробелы/скобки/+.
    phone: z
      .string()
      .optional() // Не обязательно.
      .refine(
        (val) => !val || /^[\d\s+()-]+$/.test(val), // Проверка если значение указано.
        { message: 'Телефон может содержать только цифры, пробелы, скобки и знак +' }
      )
      .transform((phone) => phone?.trim() || undefined), // Убрать пробелы или undefined.

    // password: строгие правила по PRD.
    // - Мин 8 символов.
    // - Хотя бы 1 строчная, 1 заглавная, 1 цифра.
    password: z
      .string()
      .min(8, 'Пароль должен содержать минимум 8 символов')
      .regex(/[a-z]/, 'Пароль должен содержать хотя бы одну строчную букву (a-z)')
      .regex(/[A-Z]/, 'Пароль должен содержать хотя бы одну заглавную букву (A-Z)')
      .regex(/\d/, 'Пароль должен содержать хотя бы одну цифру (0-9)'),

    // confirmPassword: для подтверждения.
    confirmPassword: z.string().min(1, 'Подтвердите пароль'),

    // agreeToTerms: обязательно true (refine проверяет).
    agreeToTerms: z.boolean().refine((val) => val === true, {
      message: 'Необходимо согласиться с пользовательским соглашением',
    }),

    // agreeToPrivacy: то же.
    agreeToPrivacy: z.boolean().refine((val) => val === true, {
      message: 'Необходимо согласиться с политикой конфиденциальности',
    }),
  })
  // Дополнительная проверка всего объекта: пароли совпадают.
  .refine((data) => data.password === data.confirmPassword, {
    message: 'Пароли не совпадают',
    path: ['confirmPassword'], // Ошибка привязана к полю confirmPassword.
  });

// Тип для register.
export type RegisterInput = z.infer<typeof registerSchema>;
