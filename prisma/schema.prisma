// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  lastName   String?
  firstName  String?
  middleName String?
  role       Role     @default(USER)
  avatar     String?
  isActive   Boolean  @default(true)

  // Связи многие-ко-многим с проектами и группами
  userProjects UserProject[]
  userGroups   UserGroup[]

  // Отношения - созданные сущности
  ownedProjects Project[]           @relation("ProjectOwner")
  createdTasks  Task[]              @relation("TaskCreator")
  
  // Отношения - участие в сущностях
  assignedTasks   TaskAssignment[]
  comments        Comment[]
  notifications   Notification[]
  activityLogs    ActivityLog[]

  // Отношения - история и делегирования
  statusChangesMade   UserStatusHistory[] @relation("StatusChanger")
  delegationsSent     TaskDelegation[]    @relation("DelegationFrom")
  delegationsReceived TaskDelegation[]    @relation("DelegationTo")
  statusHistory       UserStatusHistory[] @relation("UserStatusHistory")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("users")
}

model Project {
  id          Int           @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int
  owner       User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?

  // Связи
  groups       Group[]
  tasks        Task[]
  userProjects UserProject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("projects")
}

model Group {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  projectId   Int
  project     Project   @relation(fields: [projectId], references: [id])

  // Связи
  users      UserGroup[]
  tasks      Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("groups")
}

// Связь многие-ко-многим: Пользователи ↔ Проекты
model UserProject {
  id        Int     @id @default(autoincrement())
  userId    Int
  projectId Int
  user      User    @relation(fields: [userId], references: [id])
  project   Project @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId])
  @@map("user_projects")
}

// Связь многие-ко-многим: Пользователи ↔ Группы
model UserGroup {
  id      Int   @id @default(autoincrement())
  userId  Int
  groupId Int
  user    User  @relation(fields: [userId], references: [id])
  group   Group @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId])
  @@map("user_groups")
}

model Task {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  status          TaskStatus @default(TODO)
  priority        Priority   @default(MEDIUM)
  dueDate         DateTime?
  
  // Задача принадлежит проекту и может быть привязана к группе
  projectId Int
  project   Project @relation(fields: [projectId], references: [id])
  groupId   Int?
  group     Group?  @relation(fields: [groupId], references: [id])
  
  // Создатель задачи
  creatorId Int
  creator   User    @relation("TaskCreator", fields: [creatorId], references: [id])
  
  estimatedHours Int?
  actualHours    Int?

  // Связи
  assignments TaskAssignment[]
  delegations TaskDelegation[]
  comments    Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tasks")
}

model TaskAssignment {
  id          Int      @id @default(autoincrement())
  taskId      Int
  task        Task     @relation(fields: [taskId], references: [id])
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  assignedBy  Int
  assignedAt  DateTime @default(now())
  completedAt DateTime?

  @@map("task_assignments")
}

model TaskDelegation {
  id          Int              @id @default(autoincrement())
  taskId      Int
  task        Task             @relation(fields: [taskId], references: [id])
  fromUserId  Int
  fromUser    User             @relation("DelegationFrom", fields: [fromUserId], references: [id])
  toUserId    Int
  toUser      User             @relation("DelegationTo", fields: [toUserId], references: [id])
  reason      String?
  status      DelegationStatus @default(PENDING)
  delegatedAt DateTime         @default(now())
  approvedAt  DateTime?

  @@map("task_delegations")
}

model Comment {
  id       Int       @id @default(autoincrement())
  content  String
  taskId   Int
  task     Task      @relation(fields: [taskId], references: [id])
  authorId Int
  author   User      @relation(fields: [authorId], references: [id])
  parentId Int?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("comments")
}

model Notification {
  id         Int              @id @default(autoincrement())
  type       NotificationType
  title      String
  message    String
  userId     Int
  user       User             @relation(fields: [userId], references: [id])
  entityType String?
  entityId   Int?
  isRead     Boolean          @default(false)
  isSent     Boolean          @default(false)

  createdAt DateTime @default(now())

  @@map("notifications")
}

model ActivityLog {
  id         Int     @id @default(autoincrement())
  userId     Int
  user       User    @relation(fields: [userId], references: [id])
  actionType String
  entityType String?
  entityId   Int?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@map("activity_logs")
}

model UserStatusHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation("UserStatusHistory", fields: [userId], references: [id])
  oldStatus Boolean
  newStatus Boolean
  changedBy Int
  changer   User     @relation("StatusChanger", fields: [changedBy], references: [id])
  reason    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("user_status_history")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DelegationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DELEGATED
  TASK_STATUS_CHANGED
  TASK_COMPLETED
  NEW_COMMENT
  MENTIONED
  DEADLINE_SOON
  DEADLINE_PASSED
  USER_ACTIVATED
  USER_DEACTIVATED
  PROJECT_CREATED
  GROUP_CREATED
}