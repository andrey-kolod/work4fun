// prisma/schema.prisma

// Генератор Prisma Client - создает TypeScript клиент для работы с БД
generator client {
  provider = "prisma-client-js"
}

// Настройки подключения к базе данных
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // URL берется из переменных окружения
}

// Модель пользователя системы
model User {
  id         Int      @id @default(autoincrement()) // Первичный ключ, автоинкремент
  email      String   @unique                       // Уникальный email
  password   String                                 // Хеш пароля
  lastName   String?                                // Фамилия (опционально)
  firstName  String?                                // Имя (опционально)
  middleName String?                                // Отчество (опционально)
  role       Role     @default(USER)                // Роль пользователя
  avatar     String?                                // Аватар (URL)
  isActive   Boolean  @default(true)                // Активен ли пользователь

  // === СВЯЗИ С ПРОЕКТАМИ И ГРУППАМИ ===
  
  // Связи многие-ко-многим с проектами и группами
  userProjects UserProject[]  // Проекты пользователя
  userGroups   UserGroup[]    // Группы пользователя

  // Отношения - созданные сущности
  ownedProjects Project[] @relation("ProjectOwner")    // Созданные проекты
  createdTasks  Task[]    @relation("TaskCreator")     // Созданные задачи
  
  // === ОТНОШЕНИЯ - УЧАСТИЕ В СУЩНОСТЯХ ===
  assignedTasks   TaskAssignment[]  // Назначенные задачи
  comments        Comment[]         // Комментарии
  notifications   Notification[]    // Уведомления
  activityLogs    ActivityLog[]     // Логи действий

  // === ОТНОШЕНИЯ - ИСТОРИЯ И ДЕЛЕГИРОВАНИЯ ===
  statusChangesMade   UserStatusHistory[] @relation("StatusChanger") // Изменения статусов
  delegationsSent     TaskDelegation[]    @relation("DelegationFrom") // Отправленные делегирования
  delegationsReceived TaskDelegation[]    @relation("DelegationTo")   // Полученные делегирования
  statusHistory       UserStatusHistory[] @relation("UserStatusHistory") // История статусов пользователя

  // === ТИМСТАМПЫ ===
  createdAt DateTime @default(now()) // Дата создания
  updatedAt DateTime @updatedAt      // Дата обновления (автоматически)
  deletedAt DateTime?                // Мягкое удаление

  @@map("users") // Название таблицы в БД
}

// Модель проекта
model Project {
  id          Int           @id @default(autoincrement())
  name        String        // Название проекта
  description String?       // Описание проекта
  ownerId     Int           // Владелец проекта
  owner       User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  status      ProjectStatus @default(ACTIVE) // Статус проекта
  startDate   DateTime?     // Дата начала
  endDate     DateTime?     // Дата окончания

  // === СВЯЗИ ===
  groups       Group[]       // Группы в проекте
  tasks        Task[]        // Задачи проекта
  userProjects UserProject[] // Пользователи проекта

  // === ТИМСТАМПЫ ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("projects")
}

// Модель группы (внутри проекта)
model Group {
  id          Int       @id @default(autoincrement())
  name        String    // Название группы
  description String?   // Описание группы
  projectId   Int       // Проект, к которому принадлежит группа
  project     Project   @relation(fields: [projectId], references: [id])

  // === СВЯЗИ ===
  users      UserGroup[] // Пользователи группы
  tasks      Task[]      // Задачи группы

  // === ТИМСТАМПЫ ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("groups")
}

// Связь многие-ко-многим: Пользователи ↔ Проекты
model UserProject {
  id        Int     @id @default(autoincrement())
  userId    Int     // ID пользователя
  projectId Int     // ID проекта
  user      User    @relation(fields: [userId], references: [id])
  project   Project @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId]) // Уникальная пара пользователь-проект
  @@map("user_projects")
}

// Связь многие-ко-многим: Пользователи ↔ Группы
model UserGroup {
  id      Int   @id @default(autoincrement())
  userId  Int   // ID пользователя
  groupId Int   // ID группы
  user    User  @relation(fields: [userId], references: [id])
  group   Group @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId]) // Уникальная пара пользователь-группа
  @@map("user_groups")
}

// Модель задачи
model Task {
  id              Int       @id @default(autoincrement())
  title           String    // Заголовок задачи
  description     String?   // Описание задачи
  status          TaskStatus @default(TODO) // Статус задачи
  priority        Priority   @default(MEDIUM) // Приоритет задачи
  dueDate         DateTime?  // Срок выполнения
  
  // === СВЯЗИ С ПРОЕКТОМ И ГРУППОЙ ===
  projectId Int     // Проект задачи
  project   Project @relation(fields: [projectId], references: [id])
  groupId   Int?    // Группа задачи (опционально)
  group     Group?  @relation(fields: [groupId], references: [id])
  
  // === СОЗДАТЕЛЬ ЗАДАЧИ ===
  creatorId Int // ID создателя
  creator   User @relation("TaskCreator", fields: [creatorId], references: [id])
  
  // === ТРЕКИНГ ВРЕМЕНИ ===
  estimatedHours Int? // Плановое время (часы)
  actualHours    Int? // Фактическое время (часы)

  // === СВЯЗИ ===
  assignments TaskAssignment[] // Назначения на задачу
  delegations TaskDelegation[] // Делегирования задачи
  comments    Comment[]        // Комментарии к задаче

  // === ТИМСТАМПЫ ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tasks")
}

// Назначение задачи на пользователя
model TaskAssignment {
  id          Int      @id @default(autoincrement())
  taskId      Int      // ID задачи
  task        Task     @relation(fields: [taskId], references: [id])
  userId      Int      // ID пользователя
  user        User     @relation(fields: [userId], references: [id])
  assignedBy  Int      // Кто назначил
  assignedAt  DateTime @default(now()) // Когда назначили
  completedAt DateTime?                // Когда выполнили

  @@map("task_assignments")
}

// Делегирование задачи другому пользователю
model TaskDelegation {
  id          Int              @id @default(autoincrement())
  taskId      Int              // ID задачи
  task        Task             @relation(fields: [taskId], references: [id])
  fromUserId  Int              // От кого делегирована
  fromUser    User             @relation("DelegationFrom", fields: [fromUserId], references: [id])
  toUserId    Int              // Кому делегирована
  toUser      User             @relation("DelegationTo", fields: [toUserId], references: [id])
  reason      String?          // Причина делегирования
  status      DelegationStatus @default(PENDING) // Статус делегирования
  delegatedAt DateTime         @default(now())   // Когда делегирована
  approvedAt  DateTime?                           // Когда подтверждена

  @@map("task_delegations")
}

// Комментарии к задачам
model Comment {
  id       Int       @id @default(autoincrement())
  content  String    // Текст комментария
  taskId   Int       // ID задачи
  task     Task      @relation(fields: [taskId], references: [id])
  authorId Int       // Автор комментария
  author   User      @relation(fields: [authorId], references: [id])
  parentId Int?      // Родительский комментарий (для ветвления)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies") // Ответы на комментарий

  // === ТИМСТАМПЫ ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("comments")
}

// Уведомления для пользователей
model Notification {
  id         Int              @id @default(autoincrement())
  type       NotificationType // Тип уведомления
  title      String           // Заголовок уведомления
  message    String           // Текст уведомления
  userId     Int              // Получатель уведомления
  user       User             @relation(fields: [userId], references: [id])
  entityType String?          // Тип сущности (для ссылки)
  entityId   Int?             // ID сущности (для ссылки)
  isRead     Boolean          @default(false) // Прочитано ли
  isSent     Boolean          @default(false) // Отправлено ли

  createdAt DateTime @default(now())

  @@map("notifications")
}

// Логи действий пользователей (аудит)
model ActivityLog {
  id         Int     @id @default(autoincrement())
  userId     Int     // Пользователь, выполнивший действие
  user       User    @relation(fields: [userId], references: [id])
  actionType String  // Тип действия
  entityType String? // Тип сущности
  entityId   Int?    // ID сущности
  oldValues  Json?   // Старые значения (для обновлений)
  newValues  Json?   // Новые значения
  ipAddress  String? // IP адрес
  userAgent  String? // Информация о браузере

  createdAt DateTime @default(now())

  @@map("activity_logs")
}

// История изменений статуса пользователей
model UserStatusHistory {
  id        Int      @id @default(autoincrement())
  userId    Int      // Пользователь, чей статус изменили
  user      User     @relation("UserStatusHistory", fields: [userId], references: [id])
  oldStatus Boolean  // Старый статус
  newStatus Boolean  // Новый статус
  changedBy Int      // Кто изменил статус
  changer   User     @relation("StatusChanger", fields: [changedBy], references: [id])
  reason    String?  // Причина изменения
  ipAddress String?  // IP адрес
  userAgent String?  // Информация о браузере
  createdAt DateTime @default(now())

  @@map("user_status_history")
}

// === ПЕРЕЧИСЛЕНИЯ (ENUMS) ===

// Роли пользователей
enum Role {
  SUPER_ADMIN  // Супер-администратор (полные права)
  ADMIN        // Администратор (расширенные права)
  USER         // Обычный пользователь
}

// Статусы проектов
enum ProjectStatus {
  ACTIVE    // Активный
  COMPLETED // Завершенный
  ARCHIVED  // В архиве
}

// Статусы задач
enum TaskStatus {
  TODO        // К выполнению
  IN_PROGRESS // В работе
  REVIEW      // На проверке
  DONE        // Выполнено
}

// Приоритеты задач
enum Priority {
  LOW    // Низкий
  MEDIUM // Средний
  HIGH   // Высокий
  URGENT // Срочный
}

// Статусы делегирования
enum DelegationStatus {
  PENDING  // Ожидает подтверждения
  ACCEPTED // Принято
  REJECTED // Отклонено
}

// Типы уведомлений
enum NotificationType {
  TASK_ASSIGNED       // Задача назначена
  TASK_DELEGATED      // Задача делегирована
  TASK_STATUS_CHANGED // Статус задачи изменен
  TASK_COMPLETED      // Задача завершена
  NEW_COMMENT         // Новый комментарий
  MENTIONED           // Упомянули в комментарии
  DEADLINE_SOON       // Скоро дедлайн
  DEADLINE_PASSED     // Дедлайн прошел
  USER_ACTIVATED      // Пользователь активирован
  USER_DEACTIVATED    // Пользователь деактивирован
  PROJECT_CREATED     // Проект создан
  GROUP_CREATED       // Группа создана
}